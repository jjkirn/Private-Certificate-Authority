# Preparing a Private Certificate Chain 

> Steps to create your own private (internal) CA certificate chain and target server certificates.

These below steps are designed to help you create your own private Certificate Chain. You will start by creating a Certicicate Authority (CA) and then generating server SSL certificates for your target servers. The private certificate information needs to be moved to the target hosts and installed in the web (NGINX) server to enable SSL. You will also need to install the private CA certificate into any computer you want to access the target hosts via SSL. 

> **Note:**
>
> The following assumes you perform these steps on Linux (Ubuntu 20.04) in privileged mode (use sudo) unless otherwise noted.

## Prerequsites for CA Server
- Ubuntu 20.04 Desktop

## Generating the CA
- [Generate Certificate Authority (CA) key](#Generate Certificate Authority (CA) key).
- [Generate CA server certificate](#Generate CA server certificate).
- [Distribute your CA's Public Certificate](#Distribute your CA's Public Certificate).
- [Install your CA's Public Certificate](#Install your CA's Public Certificate).
- [Optional install of CA certificate on Windows machine](#Optional install of CA certificate on Windows machine).

### Generate Certificate Authority (CA) key
**Step 1:** To prepare the CA, start by generating the CA key. To generate the key execute the following commands in a terminal window on the CA server:
```console
sudo openssl genrsa -aes256 -out ca.key 4096
```
Where:
- -aes256 - uses the Advanced Encryption Standard - 256 bits
- -out ca.key - specifies the file to place the CA key

> **Note:** The above command will ask you for a pass phrase - make sure you save the phrase in a secure location.

### Generate CA server certificate
**Step 2:** Next the CA certificate is generated by executing the following command:
```console
sudo openssl req -x509 -new -nodes -key ca.key -sha256 -days 9999 -out ca.crt
```
Where:
- -x509 - creates an X.509 Certificate
- -new - specifies generating a new certificate
- -nodes - create a key without a passphrase
- -key ca.key - specifies the CA key file to use
- -sha256 - uses 256-bit SHA (Secure Hash Algorithm)
- -days 9999 - the number of days the certificate should be valid
- -out ca.pem - specifies the filename of the certificate

You will be prompted to fill in several items related to the certificate such as:
- Country Name (2 letter code)
- State of Province Name (full name)
- Locality Name (eg, city)
- Organization Name (eg, company)
- Organizational Name (eg, section)
- Common Name (eg, your name or your server's hostname)
- Email Address (can leave this blank)

You should now have the following files:
- ca.crt
- ca.key

### Distribute your CA's Public Certificate
**Step 3:** Now your CA is configured and ready to act as a root of trust for any systems that you want to configure to use it. You can add the CA’s certificate to your web servers, mail servers, and so on. Any user or server that needs to verify the identity of another user or server in your network should have a copy of the ca.crt file imported into their operating system’s certificate store.

To import the CA’s public certificate into a second Linux system like another server or a local computer, first obtain a copy of the ca.crt file from your CA server. You can use the cat command to output it in a terminal, and then copy and paste it into a file on the second computer that is importing the certificate. You can also use tools like scp, rsync to transfer the file between systems. 

I use scp to transfer the ca.crt file to any target server. Below is an example of how I transferred them to my target Ubuntu web server:
```console
scp ca.crt jim@registry.jkirn.com:/home/jim/Desktop/
```
You should then get prompted for the password for the jim account on registry.jkirn.com. 

### Install your CA's Public Certificate
**Step 4:** To install the CA certificate on an Ubuntu based target server follow the steps below. Login to jim at registry.jkirn.com and install the CA certificate on that Ubuntu server by executing the following:
```console
cd ~/Desktop
sudo cp ca.crt /usr/local/share/ca-certificates/
sudo update-ca-certificates
```
> **Note 1:** Although I used the account jim and target server registry.jkirn.com, you can use any of your Ubuntu servers and your appropriate account.
> **Note 2:** Installing on other Linux distributions such as CentOS will be different. Refer to their documentation.

### Optional install of CA certificate on Windows machine
**Step 5:** Windows OS machines are either part of a Active Directory (AD) forest or just part of a Workgroup. Below is how to install the CA certificate if it is just a Workgroup computer. Installing CA certificates for an AD forest is done in a more complicated manner not covered by this write up.

For a Windows Workgroup computer, start by using WinSCP to transfer the ca.pem file from the Linux CA server to the Windows machine.

Next - launch MMC and select Certificates 
- Select Computer account
- Go to Trusted Root Certification Authorities.
- Select Certificates.
- Right click to All Tasks - Select Import - Next
- Browse to the downloaded ca.pem file and select it
- Place it in the Trusted Root Certification Authorities
- Click next.
- Do the import.

Restart your browser session. Should now have the CA certificate loaded.

## Private Signed Target Server Certificate
- [Generate a target server key](###Generate a target server key)
- [Generate a target server Certificate Signing Request (CSR)](##Generate a target server Certificate Signing Request (CSR)).
- [Generate SubjectAlternativeNames file for target server](##Generate SubjectAlternativeNames file for target server).
- [Create password file](##Create password file).
- [Generate a target server certificate from server csr](##Generate a target server certificate from server csr).
- [Distribute target server certificate and install it in target server](## Distribute target server certificate and install it in target server).
- [Repeat steps 1-8 for any othe target server](##Repeat steps 1-8 for any othe target server)
- [Windows Servers - IIS](##Windows Servers - IIS)

### Generate a target server key
**Step 1:** Still on the CA server at this point. It is now time to create a private signed certificate for the target server (registry.jkirn.com) to be used for SSL operation on NGINX for example. Execute the following command to generate the target sever key:
```console
sudo openssl genrsa -out registry.key 4096
```

### Generate a target server Certificate Signing Request (CSR) 
**Step 2:** Execute the following command to generate a csr:
```console
sudo openssl req -new -key registry.key -out registry.csr -subj "/C=US/ST=Illinois/L=Chicago/O=registry/OU=docker/CN=registry.jkirn.com"
```
The following is some example information used above.
- C = Country name. The two-letter ISO abbreviation [US]
- ST = State or Province name. [Illinois]
- L = Locality Name. The name of the city where you are located. [Chicago]
- O = The fill name of you organization. [local docker registry]
- OU = Orginzational Unit. [IT]
- CN = The fully qualified domain name [registry.jkirn.com]

> **Note:** change the data to reflect your information

### Generate SubjectAlternativeNames file for target server
**Step 3:** Execute the following commands to generate a target server.ext file:
```console
cp blank.ext registry.ext
sed -i 's~SiteNameToReplace~registry.jkirn.com~g' registry.ext
```
> **Note:** Change registy.jkirn.com and registry.ext to reflect your target server. The blank.ext file is included at the end of this write up.

Running the above commands should have created the following files:
- registry.csr
- registry.key
- registry.ext

### Create password file
**Step 4:** Create the file pass.txt which contains your password.
```console
touch pass.txt
gedit pass.txt
```
This password will be used in the next step.

### Generate a target server certificate from server csr
**Step 5:** Generate a private signed server certificate for the target server from the server csr by executing the following:
```console
sudo openssl x509 -req -sha256 -days 9999 -in registry.csr -CA ca.pem -CAkey ca.key -passin file:pass.txt -CAcreateserial -extfile registry.ext -out registry.crt 
```
Running the above commands should create the following files:
- registry.crt -- this goes into the Nginx conf file as SSLCertificateFile
- registry.csr
- registry.ext
- registry.key -- this goes into the Nginx conf file as SSLCertificateKeyFile

### Distribute target server certificate and install it in target server
**Step 6:** Now we need to copy the the registry certificate files and the CA certificate and key to the target server (registry.jkirn.com). 

The steps for copying the CA information was listed in Step 3 of Distribute your CA's Public Certificate above.
 
Now the target server information needs to copied from the CA server to the target server. One way to transfer the information is via scp:
```console
scp registry.crt jim@registry.jkirn.com:/home/jim/Desktop/
scp registry.csr jim@registry.jkirn.com:/home/jim/Desktop/
scp registry.ext jim@registry.jkirn.com:/home/jim/Desktop/
scp registry.key jim@registry.jkirn.com:/home/jim/Desktop/ 
```
**Step 7:** Login to the target server (registry.jkirn.com) as user jim. Copy the Web (NGINX) related files to the correct location.
```console
cd ~/Desktop
cp registry.crt /etc/nginx/ssl/
cp registry.key /etc/nginx/ssl/
```
**Step 8:** Edit the NGINX config file to reflect the new key and crt information. Then restart NGINX. The changed lines in the NGINX config file should read:
```console
sudo gedit /etc/nginx/sites-available/default/registry.conf

# change the below lines
server {
listen 80;
listen 443 ssl;

ssl on;
SSLCertificateFile /etc/ssl/registry.pem;
SSLCertificateKeyFile /etc/ssl/registry.key;
...
}
```
> **Note:** change the "registry" fields to reflect your target server information.

**Step 9:** Restart NGINX as follows:
```console
sudo systemctl restart nginx
```
### Repeat steps 1-8 for any other target server
Steps 1-8 immediately above associated with the target server "registry" can be performed for any other Ubuntu based target server. Just replace the name "registry" with the name of your target server.

### Windows Servers - IIS
Windows IIS servers (and printers) use a binary based .pfx file. Assuming you started step 1 above with a new target server called new_server, all above steps up to Step 5 above should be the same except for the name replacement of registry to new_server. Starting at Step 5, use the below to generate the target server certificate:
```console
openssl pkcs12 -export -inkey new_server.key -in new_server.crt -out new_server.pfx -passout pass:
```
You sould now have the following files:
- new_server.crt
- new_server.csr
- new_server.ext
- new_server.key
- new_server.pfx

Next you can use WinSCP on the Windows computer to transfer
files from the Linux CA server files to that Windows server.
```console
files to transfer to Windows
- CA.pem
- new_server.pfx
```
Use IIS Manager. 
- Go to Server Certificates. Perform a "Complete a server request" using "new_server.pfx". Install it in the personal area.
- Next, under Sites, select the site (new_server), then Edit the bindings for Port 443, Select the new SSL certificate "new_server".
- Restart IIS.
- Close and Re-launch your browser to that IIS instance - it should be https!

### Example blank.ext file
Below is the contents of the blank.ext file used in creating the Subject Alternative Names:
```console
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
subjectAltName = @alt_names

[alt_names]
DNS.1 = SiteNameToReplace
```
End of Document
